$(window).on('load', function () {

    //Detecting MetaMask 
    if (typeof web3 !== 'undefined') {
        window.web3 = new Web3(web3.currentProvider);
    } else {
        var errorMsg = 'No web3? You should consider trying MetaMask!';
        $('#log').text(errorMsg);
        console.log(errorMsg);
        return;
    }

    //Set User from Metamask
    var user1Adress = web3.eth.accounts[0];
    console.log("Metamask Account: " + user1Adress);
    web3.eth.getBalance(user1Adress, function (err, balance) {
        if (err === null) {
            console.log("Balance: " + web3.fromWei(balance, "ether") + " ETH");
        }
    });

    //Initiate Standard Smart Contract
    var smartContract = web3.eth.contract(smartContractAbi);
    var smartContractAdress = "0x8516c678499eb9f7096533142d4185e181ad595b";
    var smartContractInstance = smartContract.at(smartContractAdress);
    console.log("Default Smart Contract Adress: " + smartContractInstance.address);

    //Deploy Smart Contract
    $('#form_deploy').on('submit', function (e) {
        e.preventDefault();
        smartContractInstance = smartContract.new(
            {
                from: web3.eth.accounts[0],
                data: '0x608060405234801561001057600080fd5b506118b7806100206000396000f3006080604052600436106100a35763ffffffff7c0100000000000000000000000000000000000000000000000000000000600035041663608661a481146100a85780637cbaf4a41461011f5780637d57de6c146101d95780638978a6a2146102b25780638f35eaec1461030b578063a0aead4d146103b1578063a1fc67bd146103d8578063a994a2da14610431578063c75f6089146104c8578063cd5286d0146104e0575b600080fd5b3480156100b457600080fd5b506040805160206004803580820135601f810184900484028501840190955284845261010394369492936024939284019190819084018382808284375094975050933594506105dc9350505050565b60408051600160a060020a039092168252519081900360200190f35b34801561012b57600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526101c594369492936024939284019190819084018382808284375050604080516020601f818a01358b0180359182018390048302840183018552818452989b600160a060020a038b35169b909a90999401975091955091820193509150819084018382808284375094975061066b9650505050505050565b604080519115158252519081900360200190f35b3480156101e557600080fd5b506040805160206004803580820135601f810184900484028501840190955284845261023d94369492936024939284019190819084018382808284375094975050509235600160a060020a03169350610ac592505050565b6040805160208082528351818301528351919283929083019185019080838360005b8381101561027757818101518382015260200161025f565b50505050905090810190601f1680156102a45780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3480156102be57600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526101c5943694929360249392840191908190840183828082843750949750610bd39650505050505050565b34801561031757600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526101c594369492936024939284019190819084018382808284375050604080516020601f818a01358b0180359182018390048302840183018552818452989b600160a060020a038b35169b909a909994019750919550918201935091508190840183828082843750949750610d999650505050505050565b3480156103bd57600080fd5b506103c6611021565b60408051918252519081900360200190f35b3480156103e457600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526103c69436949293602493928401919081908401838280828437509497506110289650505050505050565b34801561043d57600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526101c594369492936024939284019190819084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a9998810197919650918201945092508291508401838280828437509497506110929650505050505050565b3480156104d457600080fd5b5061023d600435611504565b3480156104ec57600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526105399436949293602493928401919081908401838280828437509497506115af9650505050505050565b6040518085600160a060020a0316600160a060020a031681526020018060200184151515158152602001838152602001828103825285818151815260200191508051906020019080838360005b8381101561059e578181015183820152602001610586565b50505050905090810190601f1680156105cb5780820380516001836020036101000a031916815260200191505b509550505050505060405180910390f35b600080836040518082805190602001908083835b6020831061060f5780518252601f1990920191602091820191016105f0565b51815160209384036101000a600019018019909216911617905292019485525060405193849003019092206002018054909250849150811061064d57fe5b600091825260209091200154600160a060020a031690505b92915050565b600033600160a060020a03166000856040518082805190602001908083835b602083106106a95780518252601f19909201916020918201910161068a565b51815160209384036101000a6000190180199092169116179052920194855250604051938490030190922054600160a060020a031692909214915081905061076857506000846040518082805190602001908083835b6020831061071e5780518252601f1990920191602091820191016106ff565b51815160209384036101000a6000190180199092169116179052920194855250604080519485900382019094203360009081526003909101909152929092206001015460ff169150505b15156107fb57604080517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603060248201527f4f6e6c7920746865206f776e6572206f722061646d696e732063616e2061646460448201527f20617574686f72697a6174696f6e732e00000000000000000000000000000000606482015290519081900360840190fd5b6000846040518082805190602001908083835b6020831061082d5780518252601f19909201916020918201910161080e565b51815160209384036101000a600019018019909216911617905292019485525060405193849003810184206002018054600181018255600091825282822001805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a038a161790558851879591945089935090918291908401908083835b602083106108c75780518252601f1990920191602091820191016108a8565b51815160209384036101000a600019018019909216911617905292019485525060408051948590038201909420600160a060020a03891660009081526003909101825293909320845161092395919491909101925090506117f3565b5060016000856040518082805190602001908083835b602083106109585780518252601f199092019160209182019101610939565b51815160209384036101000a6000190180199092169116179052920194855250604080519485900382018520600160a060020a038a16600081815260039092018452828220600101805460ff19169815159890981790975595855260608583018181528b51918701919091528a517fc6593691aaa0fd1cd0ef2a16869a77697e425eecf281497fb8e545c04c0f762c978b978d97508b96509492938501926080860192908801918190849084905b83811015610a1e578181015183820152602001610a06565b50505050905090810190601f168015610a4b5780820380516001836020036101000a031916815260200191505b50838103825284518152845160209182019186019080838360005b83811015610a7e578181015183820152602001610a66565b50505050905090810190601f168015610aab5780820380516001836020036101000a031916815260200191505b509550505050505060405180910390a15060019392505050565b60606000836040518082805190602001908083835b60208310610af95780518252601f199092019160209182019101610ada565b518151600019602094850361010090810a82019283169219939093169190911790925294909201968752604080519788900382018820600160a060020a038b166000908152600390910183528190208054601f6002600183161590980290950116959095049283018290048202880182019052818752929450925050830182828015610bc65780601f10610b9b57610100808354040283529160200191610bc6565b820191906000526020600020905b815481529060010190602001808311610ba957829003601f168201915b5050505050905092915050565b600033600160a060020a03166000836040518082805190602001908083835b60208310610c115780518252601f199092019160209182019101610bf2565b51815160209384036101000a6000190180199092169116179052920194855250604051938490030190922054600160a060020a0316929092149150819050610cd057506000826040518082805190602001908083835b60208310610c865780518252601f199092019160209182019101610c67565b51815160209384036101000a6000190180199092169116179052920194855250604080519485900382019094203360009081526003909101909152929092206001015460ff169150505b15610d90577fe02598df7006f29e5e8aa8d12314189d159bae6f9a9adf84fc3c54d44197c12b33836040518083600160a060020a0316600160a060020a0316815260200180602001828103825283818151815260200191508051906020019080838360005b83811015610d4d578181015183820152602001610d35565b50505050905090810190601f168015610d7a5780820380516001836020036101000a031916815260200191505b50935050505060405180910390a1506001610d94565b5060005b919050565b600033600160a060020a03166000856040518082805190602001908083835b60208310610dd75780518252601f199092019160209182019101610db8565b51815160209384036101000a6000190180199092169116179052920194855250604051938490030190922054600160a060020a0316929092149150819050610e9657506000846040518082805190602001908083835b60208310610e4c5780518252601f199092019160209182019101610e2d565b51815160209384036101000a6000190180199092169116179052920194855250604080519485900382019094203360009081526003909101909152929092206001015460ff169150505b1515610f2957604080517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603060248201527f4f6e6c7920746865206f776e6572206f722061646d696e732063616e2061646460448201527f20617574686f72697a6174696f6e732e00000000000000000000000000000000606482015290519081900360840190fd5b600080856040518082805190602001908083835b60208310610f5c5780518252601f199092019160209182019101610f3d565b51815160209384036101000a6000190180199092169116179052920194855250604080519485900382018520600160a060020a038a16600081815260039092018452828220600101805460ff19169815159890981790975595855260608583018181528b51918701919091528a517f56ee60e5f313caadd66e0c9bb388b1a8be85aeb86cc19c67e20bf900e293c7c2978b978d97508b965094929385019260808601929088019181908490849083811015610a1e578181015183820152602001610a06565b6001545b90565b600080826040518082805190602001908083835b6020831061105b5780518252601f19909201916020918201910161103c565b51815160209384036101000a6000190180199092169116179052920194855250604051938490030190922060020154949350505050565b600080836040518082805190602001908083835b602083106110c55780518252601f1990920191602091820191016110a6565b51815160209384036101000a600019018019909216911617905292019485525060405193849003019092206004015460ff1615915061121a9050577f8c162857a2babb214aa3eec53736fe29210ad6ec70bd43589c0d59c1c456308a33846040518083600160a060020a0316600160a060020a031681526020018060200180602001838103835284818151815260200191508051906020019080838360005b8381101561117c578181015183820152602001611164565b50505050905090810190601f1680156111a95780820380516001836020036101000a031916815260200191505b50838103825260268152602001807f4173736574207769746820746869732053657269616c20616c7265616479206581526020017f78697374732e000000000000000000000000000000000000000000000000000081525060400194505050505060405180910390a1506000610665565b336000846040518082805190602001908083835b6020831061124d5780518252601f19909201916020918201910161122e565b51815160209384036101000a60001901801990921691161790529201948552506040519384900381018420805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a039690961695909517909455505084518492600092879290918291908401908083835b602083106112da5780518252601f1990920191602091820191016112bb565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060010190805190602001906113239291906117f3565b5060016000846040518082805190602001908083835b602083106113585780518252601f199092019160209182019101611339565b51815160209384036101000a6000190180199092169116179052920194855250604051938490038101909320600401805460ff191694151594909417909355506001805480820180835560009290925286519193506113df927fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf690910191908701906117f3565b50507f94ed006719ac23b3ba97bc86ddc95b3bac36e3c5239ef00fad4f68e3b32418d33384846040518084600160a060020a0316600160a060020a031681526020018060200180602001838103835285818151815260200191508051906020019080838360005b8381101561145e578181015183820152602001611446565b50505050905090810190601f16801561148b5780820380516001836020036101000a031916815260200191505b50838103825284518152845160209182019186019080838360005b838110156114be5781810151838201526020016114a6565b50505050905090810190601f1680156114eb5780820380516001836020036101000a031916815260200191505b509550505050505060405180910390a150600192915050565b606060018281548110151561151557fe5b600091825260209182902001805460408051601f60026000196101006001871615020190941693909304928301859004850281018501909152818152928301828280156115a35780601f10611578576101008083540402835291602001916115a3565b820191906000526020600020905b81548152906001019060200180831161158657829003601f168201915b50505050509050919050565b600060606000806000856040518082805190602001908083835b602083106115e85780518252601f1990920191602091820191016115c9565b51815160209384036101000a60001901801990921691161790529201948552506040519384900381018420548951600160a060020a0390911694600094508a9350918291908401908083835b602083106116535780518252601f199092019160209182019101611634565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206001016000876040518082805190602001908083835b602083106116bb5780518252601f19909201916020918201910161169c565b51815160209384036101000a60001901801990921691161790529201948552506040519384900381018420600401548b5160ff90911694600094508c9350918291908401908083835b602083106117235780518252601f199092019160209182019101611704565b518151600019602094850361010090810a820192831692199390931691909117909252949092019687526040805197889003820188206002908101548b54601f60018216159098029095019094160494850182900482028801820190528387529095945087935084019050828280156117dd5780601f106117b2576101008083540402835291602001916117dd565b820191906000526020600020905b8154815290600101906020018083116117c057829003601f168201915b5050505050925093509350935093509193509193565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061183457805160ff1916838001178555611861565b82800160010185558215611861579182015b82811115611861578251825591602001919060010190611846565b5061186d929150611871565b5090565b61102591905b8082111561186d57600081556001016118775600a165627a7a72305820ce18d2644240cf6d7aacdcfa049e97194889d3c97d6207734104a964acf7348c0029',
                gas: '2000000' //add gasEstimate
            }, function (e, contract) {
                console.log(e, contract);
                if (typeof contract.address !== 'undefined') {
                    console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
                }
            });
    });

    //Add Asset
    $('#form_asset').on('submit', function (e) {
        e.preventDefault();
        console.log("Adding Asset to Smart Contract '" + smartContractInstance.address + "'... \n");
        smartContractInstance.newAsset($('#assetKey').val(), $('#assetDescription').val(), function (error) { });
        //Watch for role changes
        smartContractInstance.AssetCreate().watch(function (error, result) {
            if (!error) {
                console.log("The asset '" + result.args.assetKey + " / " + result.args.assetDescription + "' was created by " + result.args.account);
            }
        });
        smartContractInstance.RejectCreate().watch(function (error, result) {
            if (!error) {
                console.log(result.args.message + "Serial: " + result.args.assetKey + " / Owner: " + result.args.account);
            }
        });
    });

    //Add Authorization
    $('#form_assign').on('submit', function (e) {
        e.preventDefault();
        console.log("Assigning Role in Smart Contract '" + smartContractInstance.address + "'... \n");
        smartContractInstance.addAuthorization($('#assetKey_assign').val(), $('#address_assign').val(), $('#role_assign').val(), function (error) { });
        //Watch for role changes
        smartContractInstance.AuthorizationCreate().watch(function (error, result) {
            if (!error) {
                console.log("The role '" + result.args.authorizationRole + "' was added to the asset '" + result.args.assetKey + "' for " + result.args.account);
            }
        });
    });

    //Check Role
    $('#form_isAssigned').on('submit', function (e) {
        e.preventDefault();
        console.log("Checking Role in Smart Contract '" + smartContractInstance.address + "'... \n");
        smartContractInstance.getAssetAuthorization($('#assetKey_isAssigned').val(), $('#address_isAssigned').val(), function (error, res) {
            if(error){
                console.log(error);
            }
            console.log(res);
            //console.log(web3.utils.hexToAscii(res));
            //console.log(res.c[0]); // Your "customerName"
        });
    });
    
    //Access the Asset
    $('#form_access').on('submit', function (e) {
        e.preventDefault();
        console.log("Try to access in Smart Contract '" + smartContractInstance.address + "'... \n");
        smartContractInstance.getAccess($('#assetKey_access').val(), function (error) { });
        //Watch for role changes
        smartContractInstance.AccessLog().watch(function (error, result) {
            if (!error) {
                console.log("Access was granted to " + result.args.account + " for the Asset '" + result.args.assetKey +"'");            }
        });
    });


    //Remove Authorization
    $('#form_unassign').on('submit', function (e) {
        e.preventDefault();
        console.log("Unassigning Role in Smart Contract '" + smartContractInstance.address + "'... \n");
        smartContractInstance.removeAuthorization($('#assetKey_unassign').val(), $('#address_unassign').val(), $('#role_unassign').val(), function (error) { });
        //Watch for role changes
        smartContractInstance.AuthorizationRemove().watch(function (error, result) {
            if (!error) {
                console.log("The role '" + result.args.authorizationRole + "' was removed from the asset '" + result.args.assetKey + "' for " + result.args.account);            }
        });
    });
});