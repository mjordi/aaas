window.addEventListener('load', async () => {

    //Detecting MetaMask
    if (window.ethereum) {
        window.web3 = new Web3(ethereum);
        try {
            // Request account access if needed
            await ethereum.enable();
        } catch (error) {
            // User denied account access...
            var errorMsg = 'User denied account access!';
            $('#log').text(errorMsg);
            console.log(errorMsg);
            return;
        }
    }
    // Legacy dapp browsers...
    else if (window.web3) {
        window.web3 = new Web3(web3.currentProvider);
    }
    // Non-dapp browsers...
    else {
        var errorMsg = 'Non-Ethereum browser detected. You should consider trying MetaMask!';
        $('#log').text(errorMsg);
        console.log(errorMsg);
        return;
    }

    //Set User from Metamask
    var user1Adress = web3.eth.accounts[0];
    console.log("Metamask Account: " + user1Adress);
    web3.eth.getBalance(user1Adress, function (err, balance) {
        if (err === null) {
            console.log("Balance: " + web3.fromWei(balance, "ether") + " ETH");
        }
    });

    //Initiate Standard Smart Contract
    var smartContract = web3.eth.contract(smartContractAbi);
    var smartContractAdress = "0x0bf3ace0105ce6d6f2a75b48acc8d347fc63c81f";
    var smartContractInstance = smartContract.at(smartContractAdress);
    console.log("Default Smart Contract Adress: " + smartContractInstance.address);

    //Deploy Smart Contract
    $('#form_deploy').on('submit', function (e) {
        e.preventDefault();
        smartContractInstance = smartContract.new({
            from: web3.eth.accounts[0],
            data: '0x608060405234801561001057600080fd5b50611954806100206000396000f3006080604052600436106100a35763ffffffff7c0100000000000000000000000000000000000000000000000000000000600035041663608661a481146100a85780637c66c2a51461011f5780637cbaf4a4146101975780637d57de6c1461023d5780638978a6a214610316578063a0aead4d1461036f578063a1fc67bd14610396578063a994a2da146103ef578063c75f608914610486578063cd5286d01461049e575b600080fd5b3480156100b457600080fd5b506040805160206004803580820135601f8101849004840285018401909552848452610103943694929360249392840191908190840183828082843750949750509335945061059a9350505050565b60408051600160a060020a039092168252519081900360200190f35b34801561012b57600080fd5b506040805160206004803580820135601f810184900484028501840190955284845261018394369492936024939284019190819084018382808284375094975050509235600160a060020a0316935061062992505050565b604080519115158252519081900360200190f35b3480156101a357600080fd5b506040805160206004803580820135601f810184900484028501840190955284845261018394369492936024939284019190819084018382808284375050604080516020601f818a01358b0180359182018390048302840183018552818452989b600160a060020a038b35169b909a9099940197509195509182019350915081908401838280828437509497506109909650505050505050565b34801561024957600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526102a194369492936024939284019190819084018382808284375094975050509235600160a060020a03169350610dea92505050565b6040805160208082528351818301528351919283929083019185019080838360005b838110156102db5781810151838201526020016102c3565b50505050905090810190601f1680156103085780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561032257600080fd5b506040805160206004803580820135601f8101849004840285018401909552848452610183943694929360249392840191908190840183828082843750949750610ef89650505050505050565b34801561037b57600080fd5b506103846110be565b60408051918252519081900360200190f35b3480156103a257600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526103849436949293602493928401919081908401838280828437509497506110c59650505050505050565b3480156103fb57600080fd5b506040805160206004803580820135601f810184900484028501840190955284845261018394369492936024939284019190819084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a99988101979196509182019450925082915084018382808284375094975061112f9650505050505050565b34801561049257600080fd5b506102a16004356115a1565b3480156104aa57600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526104f794369492936024939284019190819084018382808284375094975061164c9650505050505050565b6040518085600160a060020a0316600160a060020a031681526020018060200184151515158152602001838152602001828103825285818151815260200191508051906020019080838360005b8381101561055c578181015183820152602001610544565b50505050905090810190601f1680156105895780820380516001836020036101000a031916815260200191505b509550505050505060405180910390f35b600080836040518082805190602001908083835b602083106105cd5780518252601f1990920191602091820191016105ae565b51815160209384036101000a600019018019909216911617905292019485525060405193849003019092206002018054909250849150811061060b57fe5b600091825260209091200154600160a060020a031690505b92915050565b600033600160a060020a03166000846040518082805190602001908083835b602083106106675780518252601f199092019160209182019101610648565b51815160209384036101000a6000190180199092169116179052920194855250604051938490030190922054600160a060020a031692909214915081905061072657506000836040518082805190602001908083835b602083106106dc5780518252601f1990920191602091820191016106bd565b51815160209384036101000a6000190180199092169116179052920194855250604080519485900382019094203360009081526003909101909152929092206001015460ff169150505b15156107b957604080517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603360248201527f4f6e6c7920746865206f776e6572206f722061646d696e732063616e2072656d60448201527f6f766520617574686f72697a6174696f6e732e00000000000000000000000000606482015290519081900360840190fd5b60206040519081016040528060008152506000846040518082805190602001908083835b602083106107fc5780518252601f1990920191602091820191016107dd565b51815160209384036101000a600019018019909216911617905292019485525060408051948590038201909420600160a060020a0388166000908152600390910182529390932084516108589591949190910192509050611890565b50600080846040518082805190602001908083835b6020831061088c5780518252601f19909201916020918201910161086d565b51815160209384036101000a6000190180199092169116179052920194855250604080519485900382018520600160a060020a038916600081815260039092018452828220600101805460ff19169815159890981790975595855284820181815289519186019190915288517f1a4590e74c17da0bf50c450883a372877f6ea86ce7048e248a2d8b0d279574a09689968b965094509192606085019290860191908190849084905b8381101561094c578181015183820152602001610934565b50505050905090810190601f1680156109795780820380516001836020036101000a031916815260200191505b50935050505060405180910390a150600192915050565b600033600160a060020a03166000856040518082805190602001908083835b602083106109ce5780518252601f1990920191602091820191016109af565b51815160209384036101000a6000190180199092169116179052920194855250604051938490030190922054600160a060020a0316929092149150819050610a8d57506000846040518082805190602001908083835b60208310610a435780518252601f199092019160209182019101610a24565b51815160209384036101000a6000190180199092169116179052920194855250604080519485900382019094203360009081526003909101909152929092206001015460ff169150505b1515610b2057604080517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603060248201527f4f6e6c7920746865206f776e6572206f722061646d696e732063616e2061646460448201527f20617574686f72697a6174696f6e732e00000000000000000000000000000000606482015290519081900360840190fd5b6000846040518082805190602001908083835b60208310610b525780518252601f199092019160209182019101610b33565b51815160209384036101000a600019018019909216911617905292019485525060405193849003810184206002018054600181018255600091825282822001805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a038a161790558851879591945089935090918291908401908083835b60208310610bec5780518252601f199092019160209182019101610bcd565b51815160209384036101000a600019018019909216911617905292019485525060408051948590038201909420600160a060020a038916600090815260039091018252939093208451610c489591949190910192509050611890565b5060016000856040518082805190602001908083835b60208310610c7d5780518252601f199092019160209182019101610c5e565b51815160209384036101000a6000190180199092169116179052920194855250604080519485900382018520600160a060020a038a16600081815260039092018452828220600101805460ff19169815159890981790975595855260608583018181528b51918701919091528a517fc6593691aaa0fd1cd0ef2a16869a77697e425eecf281497fb8e545c04c0f762c978b978d97508b96509492938501926080860192908801918190849084905b83811015610d43578181015183820152602001610d2b565b50505050905090810190601f168015610d705780820380516001836020036101000a031916815260200191505b50838103825284518152845160209182019186019080838360005b83811015610da3578181015183820152602001610d8b565b50505050905090810190601f168015610dd05780820380516001836020036101000a031916815260200191505b509550505050505060405180910390a15060019392505050565b60606000836040518082805190602001908083835b60208310610e1e5780518252601f199092019160209182019101610dff565b518151600019602094850361010090810a82019283169219939093169190911790925294909201968752604080519788900382018820600160a060020a038b166000908152600390910183528190208054601f6002600183161590980290950116959095049283018290048202880182019052818752929450925050830182828015610eeb5780601f10610ec057610100808354040283529160200191610eeb565b820191906000526020600020905b815481529060010190602001808311610ece57829003601f168201915b5050505050905092915050565b600033600160a060020a03166000836040518082805190602001908083835b60208310610f365780518252601f199092019160209182019101610f17565b51815160209384036101000a6000190180199092169116179052920194855250604051938490030190922054600160a060020a0316929092149150819050610ff557506000826040518082805190602001908083835b60208310610fab5780518252601f199092019160209182019101610f8c565b51815160209384036101000a6000190180199092169116179052920194855250604080519485900382019094203360009081526003909101909152929092206001015460ff169150505b156110b5577fe02598df7006f29e5e8aa8d12314189d159bae6f9a9adf84fc3c54d44197c12b33836040518083600160a060020a0316600160a060020a0316815260200180602001828103825283818151815260200191508051906020019080838360005b8381101561107257818101518382015260200161105a565b50505050905090810190601f16801561109f5780820380516001836020036101000a031916815260200191505b50935050505060405180910390a15060016110b9565b5060005b919050565b6001545b90565b600080826040518082805190602001908083835b602083106110f85780518252601f1990920191602091820191016110d9565b51815160209384036101000a6000190180199092169116179052920194855250604051938490030190922060020154949350505050565b600080836040518082805190602001908083835b602083106111625780518252601f199092019160209182019101611143565b51815160209384036101000a600019018019909216911617905292019485525060405193849003019092206004015460ff161591506112b79050577f8c162857a2babb214aa3eec53736fe29210ad6ec70bd43589c0d59c1c456308a33846040518083600160a060020a0316600160a060020a031681526020018060200180602001838103835284818151815260200191508051906020019080838360005b83811015611219578181015183820152602001611201565b50505050905090810190601f1680156112465780820380516001836020036101000a031916815260200191505b50838103825260268152602001807f4173736574207769746820746869732053657269616c20616c7265616479206581526020017f78697374732e000000000000000000000000000000000000000000000000000081525060400194505050505060405180910390a1506000610623565b336000846040518082805190602001908083835b602083106112ea5780518252601f1990920191602091820191016112cb565b51815160209384036101000a60001901801990921691161790529201948552506040519384900381018420805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a039690961695909517909455505084518492600092879290918291908401908083835b602083106113775780518252601f199092019160209182019101611358565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060010190805190602001906113c0929190611890565b5060016000846040518082805190602001908083835b602083106113f55780518252601f1990920191602091820191016113d6565b51815160209384036101000a6000190180199092169116179052920194855250604051938490038101909320600401805460ff1916941515949094179093555060018054808201808355600092909252865191935061147c927fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf69091019190870190611890565b50507f94ed006719ac23b3ba97bc86ddc95b3bac36e3c5239ef00fad4f68e3b32418d33384846040518084600160a060020a0316600160a060020a031681526020018060200180602001838103835285818151815260200191508051906020019080838360005b838110156114fb5781810151838201526020016114e3565b50505050905090810190601f1680156115285780820380516001836020036101000a031916815260200191505b50838103825284518152845160209182019186019080838360005b8381101561155b578181015183820152602001611543565b50505050905090810190601f1680156115885780820380516001836020036101000a031916815260200191505b509550505050505060405180910390a150600192915050565b60606001828154811015156115b257fe5b600091825260209182902001805460408051601f60026000196101006001871615020190941693909304928301859004850281018501909152818152928301828280156116405780601f1061161557610100808354040283529160200191611640565b820191906000526020600020905b81548152906001019060200180831161162357829003601f168201915b50505050509050919050565b600060606000806000856040518082805190602001908083835b602083106116855780518252601f199092019160209182019101611666565b51815160209384036101000a60001901801990921691161790529201948552506040519384900381018420548951600160a060020a0390911694600094508a9350918291908401908083835b602083106116f05780518252601f1990920191602091820191016116d1565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206001016000876040518082805190602001908083835b602083106117585780518252601f199092019160209182019101611739565b51815160209384036101000a60001901801990921691161790529201948552506040519384900381018420600401548b5160ff90911694600094508c9350918291908401908083835b602083106117c05780518252601f1990920191602091820191016117a1565b518151600019602094850361010090810a820192831692199390931691909117909252949092019687526040805197889003820188206002908101548b54601f600182161590980290950190941604948501829004820288018201905283875290959450879350840190508282801561187a5780601f1061184f5761010080835404028352916020019161187a565b820191906000526020600020905b81548152906001019060200180831161185d57829003601f168201915b5050505050925093509350935093509193509193565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106118d157805160ff19168380011785556118fe565b828001600101855582156118fe579182015b828111156118fe5782518255916020019190600101906118e3565b5061190a92915061190e565b5090565b6110c291905b8082111561190a57600081556001016119145600a165627a7a72305820fed6c061029651f5486c320a7e882c7dcb40615aaca2d4f867d04045d8d7e2140029',
            gas: '2000000' //add gasEstimate
        }, function (e, contract) {
            console.log(e, contract);
            if (typeof contract.address !== 'undefined') {
                console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
            }
        });
    });

    //Add Asset
    $('#form_asset').on('submit', function (e) {
        e.preventDefault();
        console.log("Adding Asset to Smart Contract '" + smartContractInstance.address + "'... \n");
        smartContractInstance.newAsset($('#assetKey').val(), $('#assetDescription').val(), function (error) {});
        //Watch for role changes
        smartContractInstance.AssetCreate().watch(function (error, result) {
            if (!error) {
                console.log("The asset '" + result.args.assetKey + " / " + result.args.assetDescription + "' was created by " + result.args.account);
            }
        });
        smartContractInstance.RejectCreate().watch(function (error, result) {
            if (!error) {
                console.log(result.args.message + "Serial: " + result.args.assetKey + " / Owner: " + result.args.account);
            }
        });
    });

    //Add Authorization
    $('#form_assign').on('submit', function (e) {
        e.preventDefault();
        console.log("Assigning Role in Smart Contract '" + smartContractInstance.address + "'... \n");
        smartContractInstance.addAuthorization($('#assetKey_assign').val(), $('#address_assign').val(), $('#role_assign').val(), function (error) {});
        //Watch for role changes
        smartContractInstance.AuthorizationCreate().watch(function (error, result) {
            if (!error) {
                console.log("The role '" + result.args.authorizationRole + "' was added to the asset '" + result.args.assetKey + "' for " + result.args.account);
            }
        });
    });

    //Check Role
    $('#form_isAssigned').on('submit', function (e) {
        e.preventDefault();
        console.log("Checking Role in Smart Contract '" + smartContractInstance.address + "'... \n");
        smartContractInstance.getAssetAuthorization($('#assetKey_isAssigned').val(), $('#address_isAssigned').val(), function (error, res) {
            if (error) {
                console.log(error);
            }
            console.log(res);
            //console.log(web3.utils.hexToAscii(res));
            //console.log(res.c[0]); // Your "customerName"
        });
    });

    //Access the Asset
    $('#form_access').on('submit', function (e) {
        e.preventDefault();
        console.log("Try to access in Smart Contract '" + smartContractInstance.address + "'... \n");
        smartContractInstance.getAccess($('#assetKey_access').val(), function (error) {});
        //Watch for access verification
        smartContractInstance.AccessLog().watch(function (error, result) {
            // -----
            // TBD - Check if result = true or false
            // -----
            if (!error) {
                if (result) {
                    console.log("Access was granted to " + result.args.account + " for the Asset '" + result.args.assetKey + "'");
                } else {
                    console.log("Access was NOT granted to " + result.args.account + " for the Asset '" + result.args.assetKey + "'");
                }
            }
        });
    });


    //Remove Authorization
    $('#form_unassign').on('submit', function (e) {
        e.preventDefault();
        console.log("Unassigning Role in Smart Contract '" + smartContractInstance.address + "'... \n");
        smartContractInstance.removeAuthorization($('#assetKey_unassign').val(), $('#address_unassign').val(), function (error) {});
        //Watch for role changes
        smartContractInstance.AuthorizationRemove().watch(function (error, result) {
            if (!error) {
                console.log("The role was removed from the asset '" + result.args.assetKey + "' for " + result.args.account);
            }
        });
    });
});